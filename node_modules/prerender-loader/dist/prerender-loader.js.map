{"version":3,"file":"prerender-loader.js","sources":["../src/util.js","../src/webpack-util.js","../src/index.js"],"sourcesContent":["/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport path from 'path';\n\n/**\n * Promisified version of compiler.runAsChild() with error hoisting and isolated output/assets.\n * (runAsChild() merges assets into the parent compilation, we don't want that)\n */\nexport function runChildCompiler (compiler) {\n  return new Promise((resolve, reject) => {\n    compiler.compile((err, compilation) => {\n      // still allow the parent compiler to track execution of the child:\n      compiler.parentCompilation.children.push(compilation);\n      if (err) return reject(err);\n\n      // Bubble stat errors up and reject the Promise:\n      if (compilation.errors && compilation.errors.length) {\n        const errorDetails = compilation.errors.map(error => error.details).join('\\n');\n        return reject(Error('Child compilation failed:\\n' + errorDetails));\n      }\n\n      resolve(compilation);\n    });\n  });\n}\n\n/** Crawl up the compiler tree and return the outermost compiler instance */\nexport function getRootCompiler (compiler) {\n  while (compiler.parentCompilation && compiler.parentCompilation.compiler) {\n    compiler = compiler.parentCompilation.compiler;\n  }\n  return compiler;\n}\n\n/** Find the best possible export for an ES Module. Returns `undefined` for no exports. */\nexport function getBestModuleExport (exports) {\n  if (exports.default) {\n    return exports.default;\n  }\n  for (const prop in exports) {\n    if (prop !== '__esModule') {\n      return exports[prop];\n    }\n  }\n}\n\n/** Wrap a String up into an ES Module that exports it */\nexport function stringToModule (str) {\n  return 'export default ' + JSON.stringify(str);\n}\n\nexport function convertPathToRelative (context, entry, prefix = '') {\n  if (Array.isArray(entry)) {\n    return entry.map(entry => prefix + path.relative(context, entry));\n  } else if (entry && typeof entry === 'object') {\n    return Object.keys(entry).reduce((acc, key) => {\n      acc[key] = Array.isArray(entry[key])\n        ? entry[key].map(item => prefix + path.relative(context, item))\n        : prefix + path.relative(context, entry[key]);\n      return acc;\n    }, {});\n  }\n  return prefix + path.relative(context, entry);\n}\n","/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport SingleEntryPlugin from 'webpack/lib/SingleEntryPlugin';\nimport MultiEntryPlugin from 'webpack/lib/MultiEntryPlugin';\n\n/** Handle \"object\", \"string\" and \"array\" types of entry */\nexport function applyEntry (context, entry, compiler) {\n  if (typeof entry === 'string' || Array.isArray(entry)) {\n    itemToPlugin(context, entry, 'main').apply(compiler);\n  } else if (typeof entry === 'object') {\n    Object.keys(entry).forEach(name => {\n      itemToPlugin(context, entry[name], name).apply(compiler);\n    });\n  }\n}\n\nfunction itemToPlugin (context, item, name) {\n  if (Array.isArray(item)) {\n    return new MultiEntryPlugin(context, item, name);\n  }\n\n  return new SingleEntryPlugin(context, item, name);\n}\n","/**\n * Copyright 2018 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n * use this file except in compliance with the License. You may obtain a copy of\n * the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n * License for the specific language governing permissions and limitations under\n * the License.\n */\n\nimport os from 'os';\nimport jsdom from 'jsdom';\nimport loaderUtils from 'loader-utils';\nimport LibraryTemplatePlugin from 'webpack/lib/LibraryTemplatePlugin';\nimport NodeTemplatePlugin from 'webpack/lib/node/NodeTemplatePlugin';\nimport NodeTargetPlugin from 'webpack/lib/node/NodeTargetPlugin';\nimport { DefinePlugin } from 'webpack';\nimport MemoryFs from 'memory-fs';\nimport { runChildCompiler, getRootCompiler, getBestModuleExport, stringToModule, convertPathToRelative } from './util';\nimport { applyEntry } from './webpack-util';\n\n// Used to annotate this plugin's hooks in Tappable invocations\nconst PLUGIN_NAME = 'prerender-loader';\n\n// Internal name used for the output bundle (never written to disk)\nconst FILENAME = 'ssr-bundle.js';\n\n// Searches for fields of the form {{prerender}} or {{prerender:./some/module}}\nconst PRERENDER_REG = /\\{\\{prerender(?::\\s*([^}]+?)\\s*)?\\}\\}/;\n\n/**\n * prerender-loader can be applied to any HTML or JS file with the given options.\n * @public\n * @param {Options} options Options to control how Critters inlines CSS.\n *\n * @example\n * // webpack.config.js\n * module.exports = {\n *   plugins: [\n *     new HtmlWebpackPlugin({\n *       // `!!` tells webpack to skip any configured loaders for .html files\n *       // `?string` tells prerender-loader output a JS module exporting the HTML string\n *       template: '!!prerender-loader?string!index.html'\n *     })\n *   ]\n * }\n *\n * @example\n * // inline demo: assumes you have html-loader set up:\n * import prerenderedHtml from '!prerender-loader!./file.html';\n */\nexport default function PrerenderLoader (content) {\n  const options = loaderUtils.getOptions(this) || {};\n  const outputFilter = options.as === 'string' || options.string ? stringToModule : String;\n\n  if (options.disabled === true) {\n    return outputFilter(content);\n  }\n\n  // When applied to HTML, attempts to inject into a specified {{prerender}} field.\n  // @note: this is only used when the entry module exports a String or function\n  // that resolves to a String, otherwise the whole document is serialized.\n  let inject = false;\n  if (!this.request.match(/.(js|ts)x?$/i)) {\n    const matches = content.match(PRERENDER_REG);\n    if (matches) {\n      inject = true;\n      options.entry = matches[1];\n    }\n    options.templateContent = content;\n  }\n\n  const callback = this.async();\n\n  prerender(this._compilation, this.request, options, inject, this)\n    .then(output => {\n      callback(null, outputFilter(output));\n    })\n    .catch(err => {\n      // console.error(err);\n      callback(err);\n    });\n}\n\nasync function prerender (parentCompilation, request, options, inject, loader) {\n  const parentCompiler = getRootCompiler(parentCompilation.compiler);\n  const context = parentCompiler.options.context || process.cwd();\n  const customEntry = options.entry && ([].concat(options.entry).pop() || '').trim();\n  const entry = customEntry ? ('./' + customEntry) : convertPathToRelative(context, parentCompiler.options.entry, './');\n\n  const outputOptions = {\n    // fix: some plugins ignore/bypass outputfilesystem, so use a temp directory and ignore any writes.\n    path: os.tmpdir(),\n    filename: FILENAME\n  };\n\n  // Only copy over mini-extract-text-plugin (excluding it breaks extraction entirely)\n  const plugins = (parentCompiler.options.plugins || []).filter(c => /MiniCssExtractPlugin/i.test(c.constructor.name));\n\n  // Compile to an in-memory filesystem since we just want the resulting bundled code as a string\n  const compiler = parentCompilation.createChildCompiler('prerender', outputOptions, plugins);\n  compiler.context = parentCompiler.context;\n  compiler.outputFileSystem = new MemoryFs();\n\n  // Define PRERENDER to be true within the SSR bundle\n  new DefinePlugin({\n    PRERENDER: 'true'\n  }).apply(compiler);\n\n  // ... then define PRERENDER to be false within the client bundle\n  new DefinePlugin({\n    PRERENDER: 'false'\n  }).apply(parentCompiler);\n\n  // Compile to CommonJS to be executed by Node\n  new NodeTemplatePlugin(outputOptions).apply(compiler);\n  new NodeTargetPlugin().apply(compiler);\n\n  new LibraryTemplatePlugin('PRERENDER_RESULT', 'var').apply(compiler);\n\n  // Kick off compilation at our entry module (either the parent compiler's entry or a custom one defined via `{{prerender:entry.js}}`)\n  applyEntry(context, entry, compiler);\n\n  // Set up cache inheritance for the child compiler\n  const subCache = 'subcache ' + request;\n  function addChildCache (compilation, data) {\n    if (compilation.cache) {\n      if (!compilation.cache[subCache]) compilation.cache[subCache] = {};\n      compilation.cache = compilation.cache[subCache];\n    }\n  }\n  if (compiler.hooks) {\n    compiler.hooks.compilation.tap(PLUGIN_NAME, addChildCache);\n  } else {\n    compiler.plugin('compilation', addChildCache);\n  }\n\n  const compilation = await runChildCompiler(compiler);\n  let result;\n  let dom, window, injectParent, injectNextSibling;\n\n  // A promise-like that never resolves and does not retain references to callbacks.\n  function BrokenPromise () {}\n  BrokenPromise.prototype.then = BrokenPromise.prototype.catch = BrokenPromise.prototype.finally = () => new BrokenPromise();\n\n  if (compilation.assets[compilation.options.output.filename]) {\n    // Get the compiled main bundle\n    const output = compilation.assets[compilation.options.output.filename].source();\n\n    // @TODO: provide a non-DOM option to allow turning off JSDOM entirely.\n\n    const tpl = options.templateContent || '<!DOCTYPE html><html><head></head><body></body></html>';\n    dom = new jsdom.JSDOM(tpl.replace(PRERENDER_REG, '<div id=\"PRERENDER_INJECT\"></div>'), {\n      // suppress console-proxied eval() errors, but keep console proxying\n      virtualConsole: new jsdom.VirtualConsole({ omitJSDOMErrors: false }).sendTo(console),\n\n      // `url` sets the value returned by `window.location`, `document.URL`...\n      // Useful for routers that depend on the current URL (such as react-router or reach-router)\n      url: options.documentUrl || 'http://localhost',\n\n      // don't track source locations for performance reasons\n      includeNodeLocations: false,\n\n      // don't allow inline event handlers & script tag exec\n      runScripts: 'outside-only'\n    });\n    window = dom.window;\n\n    // Find the placeholder node for injection & remove it\n    const injectPlaceholder = window.document.getElementById('PRERENDER_INJECT');\n    if (injectPlaceholder) {\n      injectParent = injectPlaceholder.parentNode;\n      injectNextSibling = injectPlaceholder.nextSibling;\n      injectPlaceholder.remove();\n    }\n\n    // These are missing from JSDOM\n    let counter = 0;\n    window.requestAnimationFrame = () => ++counter;\n    window.cancelAnimationFrame = () => { };\n\n    // Never prerender Custom Elements: by skipping registration, we get only the Light DOM which is desirable.\n    window.customElements = {\n      define () {},\n      get () {},\n      upgrade () {},\n      whenDefined: () => new BrokenPromise()\n    };\n\n    // Fake MessagePort\n    window.MessagePort = function () {\n      (this.port1 = new window.EventTarget()).postMessage = () => {};\n      (this.port2 = new window.EventTarget()).postMessage = () => {};\n    };\n\n    // Never matches\n    window.matchMedia = () => ({ addListener () {} });\n\n    // Never register ServiceWorkers\n    if (!window.navigator) window.navigator = {};\n    window.navigator.serviceWorker = {\n      register: () => new BrokenPromise()\n    };\n\n    // When DefinePlugin isn't sufficient\n    window.PRERENDER = true;\n\n    // Inject a require shim\n    window.require = moduleId => {\n      const asset = compilation.assets[moduleId.replace(/^\\.?\\//g, '')];\n      if (!asset) {\n        throw Error(`Error:  Module not found. attempted require(\"${moduleId}\")`);\n      }\n      const mod = { exports: {} };\n      window.eval(`(function(exports, module, require){\\n${asset.source()}\\n})`)(mod.exports, mod, window.require);\n      return mod.exports;\n    };\n\n    // Invoke the SSR bundle within the JSDOM document and grab the exported/returned result\n    result = window.eval(output + '\\nPRERENDER_RESULT');\n  }\n\n  // Deal with ES Module exports (just use the best guess):\n  if (result && typeof result === 'object') {\n    result = getBestModuleExport(result);\n  }\n\n  if (typeof result === 'function') {\n    result = result(options.params || null);\n  }\n\n  // The entry can export or return a Promise in order to perform fully async prerendering:\n  if (result && result.then) {\n    result = await result;\n  }\n\n  // Returning or resolving to `null` / `undefined` defaults to serializing the whole document.\n  // Note: this pypasses `inject` because the document is already derived from the template.\n  if (result !== undefined && options.templateContent) {\n    const template = window.document.createElement('template');\n    template.innerHTML = result || '';\n    const content = template.content || template;\n    const parent = injectParent || window.document.body;\n    let child;\n    while ((child = content.firstChild)) {\n      parent.insertBefore(child, injectNextSibling || null);\n    }\n  } else if (inject) {\n    // Otherwise inject the prerendered HTML into the template\n    return options.templateContent.replace(PRERENDER_REG, result || '');\n  }\n\n  // dom.serialize() doesn't properly serialize HTML appended to document.body.\n  // return `<!DOCTYPE ${window.document.doctype.name}>${window.document.documentElement.outerHTML}`;\n  let serialized = dom.serialize();\n  if (!/^<!DOCTYPE /mi.test(serialized)) {\n    serialized = `<!DOCTYPE html>${serialized}`;\n  }\n  return serialized;\n\n  // // Returning or resolving to `null` / `undefined` defaults to serializing the whole document.\n  // // Note: this pypasses `inject` because the document is already derived from the template.\n  // if (result == null && dom) {\n  //   // result = dom.serialize();\n  // } else if (inject) {\n  //   // @TODO determine if this is really worthwhile/necessary for the string return case\n  //   if (injectParent || options.templateContent) {\n  //     console.log(injectParent.outerHTML);\n  //     (injectParent || document.body).insertAdjacentHTML('beforeend', result || '');\n  //     // result = dom.serialize();\n  //   } else {\n  //     // Otherwise inject the prerendered HTML into the template\n  //     return options.templateContent.replace(PRERENDER_REG, result || '');\n  //   }\n  // }\n\n  // return dom.serialize();\n  // return result;\n}\n"],"names":["const","let","DefinePlugin"],"mappings":";;;;;;;;;;;;;;AAsBO,SAAS,iBAAkB,UAAU;IAC1C,OAAO,IAAI,OAAJ,WAAa,OAAS,EAAA,QAAV;QACjB,QAAA,CAAS,OAAT,WAAkB,GAAK,EAAA,aAAN;YAEf,QAAA,CAAS,iBAAT,CAA2B,QAA3B,CAAoC,IAApC,CAAyC;YACzC,IAAI;kBAAK,OAAO,MAAA,CAAO;YAGvB,IAAI,WAAA,CAAY,MAAZ,IAAsB,WAAA,CAAY,MAAZ,CAAmB,QAAQ;gBACnDA,IAAM,eAAe,WAAA,CAAY,MAAZ,CAAmB,GAAnB,WAAuB,gBAAS,KAAA,CAAM,WAAtC,CAA+C,IAA/C,CAAoD;gBACzE,OAAO,MAAA,CAAO,KAAA,CAAM,6BAAA,GAAgC;;YAGtD,OAAA,CAAQ;;;;;AAMd,AAAO,SAAS,gBAAiB,UAAU;IACzC,OAAO,QAAA,CAAS,iBAAT,IAA8B,QAAA,CAAS,iBAAT,CAA2B,UAAU;QACxE,QAAA,GAAW,QAAA,CAAS,iBAAT,CAA2B;;IAExC,OAAO;;;AAIT,AAAO,SAAS,oBAAqB,SAAS;IAC5C,IAAI,OAAA,CAAQ,SAAS;QACnB,OAAO,OAAA,CAAQ;;IAEjB,KAAKA,IAAM,QAAQ,SAAS;QAC1B,IAAI,IAAA,KAAS,cAAc;YACzB,OAAO,OAAA,CAAQ;;;;;AAMrB,AAAO,SAAS,eAAgB,KAAK;IACnC,OAAO,iBAAA,GAAoB,IAAA,CAAK,SAAL,CAAe;;;AAG5C,AAAO,SAAS,sBAAuB,OAAS,EAAA,KAAO,EAAA,QAAa;mCAAb,GAAS;;IAC9D,IAAI,KAAA,CAAM,OAAN,CAAc,QAAQ;QACxB,OAAO,KAAA,CAAM,GAAN,WAAU,gBAAS,MAAA,GAAS,IAAA,CAAK,QAAL,CAAc,SAAS;WACrD,IAAI,KAAA,IAAS,OAAO,KAAP,KAAiB,UAAU;QAC7C,OAAO,MAAA,CAAO,IAAP,CAAY,MAAZ,CAAmB,MAAnB,WAA2B,GAAK,EAAA,KAAN;YAC/B,GAAA,CAAI,IAAJ,GAAW,KAAA,CAAM,OAAN,CAAc,KAAA,CAAM,KAApB,GACP,KAAA,CAAM,IAAN,CAAW,GAAX,WAAe,eAAQ,MAAA,GAAS,IAAA,CAAK,QAAL,CAAc,SAAS,YACvD,MAAA,GAAS,IAAA,CAAK,QAAL,CAAc,SAAS,KAAA,CAAM;YAC1C,OAAO;WACN;;IAEL,OAAO,MAAA,GAAS,IAAA,CAAK,QAAL,CAAc,SAAS;;;ACxDlC,SAAS,WAAY,OAAS,EAAA,KAAO,EAAA,UAAU;IACpD,IAAI,OAAO,KAAP,KAAiB,QAAjB,IAA6B,KAAA,CAAM,OAAN,CAAc,QAAQ;QACrD,YAAA,CAAa,SAAS,OAAO,OAA7B,CAAqC,KAArC,CAA2C;WACtC,IAAI,OAAO,KAAP,KAAiB,UAAU;QACpC,MAAA,CAAO,IAAP,CAAY,MAAZ,CAAmB,OAAnB,WAA2B;YACzB,YAAA,CAAa,SAAS,KAAA,CAAM,OAAO,KAAnC,CAAyC,KAAzC,CAA+C;;;;;AAKrD,SAAS,aAAc,OAAS,EAAA,IAAM,EAAA,MAAM;IAC1C,IAAI,KAAA,CAAM,OAAN,CAAc,OAAO;QACvB,OAAO,IAAI,gBAAJ,CAAqB,SAAS,MAAM;;IAG7C,OAAO,IAAI,iBAAJ,CAAsB,SAAS,MAAM;;;ACP9CA,IAAM,cAAc;AAGpBA,IAAM,WAAW;AAGjBA,IAAM,gBAAgB;AAuBtB,AAAe,SAAS,gBAAiB,SAAS;IAChDA,IAAM,UAAU,WAAA,CAAY,UAAZ,CAAuB,KAAvB,IAAgC;IAChDA,IAAM,eAAe,OAAA,CAAQ,EAAR,KAAe,QAAf,IAA2B,OAAA,CAAQ,MAAnC,GAA4C,iBAAiB;IAElF,IAAI,OAAA,CAAQ,QAAR,KAAqB,MAAM;QAC7B,OAAO,YAAA,CAAa;;IAMtBC,IAAI,SAAS;IACb,IAAI,CAAC,IAAA,CAAK,OAAL,CAAa,KAAb,CAAmB,iBAAiB;QACvCD,IAAM,UAAU,OAAA,CAAQ,KAAR,CAAc;QAC9B,IAAI,SAAS;YACX,MAAA,GAAS;YACT,OAAA,CAAQ,KAAR,GAAgB,OAAA,CAAQ;;QAE1B,OAAA,CAAQ,eAAR,GAA0B;;IAG5BA,IAAM,WAAW,IAAA,CAAK,KAAL;IAEjB,SAAA,CAAU,IAAA,CAAK,cAAc,IAAA,CAAK,SAAS,SAAS,QAAQ,KAA5D,CACG,IADH,WACQ;QACJ,QAAA,CAAS,MAAM,YAAA,CAAa;MAFhC,CAIG,KAJH,WAIS;QAEL,QAAA,CAAS;;;;AAIf,SAAe,UAAW,iBAAmB,EAAA,OAAS,EAAA,OAAS,EAAA,MAAQ,EAAA;IAAvE;;;QAyCE,SAAS,cAAe,WAAa,EAAA,MAAM;YACzC,IAAI,WAAA,CAAY,OAAO;gBACrB,IAAI,CAAC,WAAA,CAAY,KAAZ,CAAkB;sBAAW,WAAA,CAAY,KAAZ,CAAkB,SAAlB,GAA8B;gBAChE,WAAA,CAAY,KAAZ,GAAoB,WAAA,CAAY,KAAZ,CAAkB;;;;QAc1C,SAAS,gBAAiB;;QAzDpB,iBAAiB,eAAA,CAAgB,iBAAA,CAAkB;QACnD,UAAU,cAAA,CAAe,OAAf,CAAuB,OAAvB,IAAkC,OAAA,CAAQ,GAAR;QAC5C,cAAc,OAAA,CAAQ,KAAR,KAAkB,EAAA,CAAG,MAAH,CAAU,OAAA,CAAQ,MAAlB,CAAyB,GAAzB,EAAA,IAAkC,IAAI,IAAvC;QAC/B,QAAQ,WAAA,GAAe,IAAA,GAAO,cAAe,qBAAA,CAAsB,SAAS,cAAA,CAAe,OAAf,CAAuB,OAAO;QAE1G,gBAAgB;YAEpB,MAAM,EAAA,CAAG,MAAH,EAFc;YAGpB,UAAU;;QAIN,WAAW,cAAA,CAAe,OAAf,CAAuB,OAAvB,IAAkC,IAAI,MAAvC,WAA8C,YAAK,uBAAA,CAAwB,IAAxB,CAA6B,CAAA,CAAE,WAAF,CAAc;QAGxG,WAAW,iBAAA,CAAkB,mBAAlB,CAAsC,aAAa,eAAe;QACnF,QAAA,CAAS,OAAT,GAAmB,cAAA,CAAe;QAClC,QAAA,CAAS,gBAAT,GAA4B,IAAI,QAAJ;QAG5B,IAAIE,oBAAJ,CAAiB;YACf,WAAW;UADb,CAEG,KAFH,CAES;QAGT,IAAIA,oBAAJ,CAAiB;YACf,WAAW;UADb,CAEG,KAFH,CAES;QAGT,IAAI,kBAAJ,CAAuB,cAAvB,CAAsC,KAAtC,CAA4C;QAC5C,IAAI,gBAAJ,EAAA,CAAuB,KAAvB,CAA6B;QAE7B,IAAI,qBAAJ,CAA0B,oBAAoB,MAA9C,CAAqD,KAArD,CAA2D;QAG3D,UAAA,CAAW,SAAS,OAAO;QAGrB,WAAW,WAAA,GAAc;QAO/B,IAAI,QAAA,CAAS,OAAO;YAClB,QAAA,CAAS,KAAT,CAAe,WAAf,CAA2B,GAA3B,CAA+B,aAAa;eACvC;YACL,QAAA,CAAS,MAAT,CAAgB,eAAe;;QAGb,OAAM,gBAAA,CAAiB,UAAvB;;gBAAd,cAAc;gBAMpB,aAAA,CAAc,SAAd,CAAwB,IAAxB,IAA+B,aAAA,CAAc,SAAd,CAAwB,KAAxB,IAAgC,aAAA,CAAc,SAAd,CAAwB,OAAxB,gBAAkC,SAAM,IAAI,aAAJ;gBAEvG,IAAI,WAAA,CAAY,MAAZ,CAAmB,WAAA,CAAY,OAAZ,CAAoB,MAApB,CAA2B,WAAW;oBAErD,SAAS,WAAA,CAAY,MAAZ,CAAmB,WAAA,CAAY,OAAZ,CAAoB,MAApB,CAA2B,SAA9C,CAAwD,MAAxD;oBAIT,MAAM,OAAA,CAAQ,eAAR,IAA2B;oBACvC,GAAA,GAAM,IAAI,KAAA,CAAM,KAAV,CAAgB,GAAA,CAAI,OAAJ,CAAY,eAAe,sCAAsC;wBAErF,gBAAgB,IAAI,KAAA,CAAM,cAAV,CAAyB;4BAAE,iBAAiB;0BAA5C,CAAqD,MAArD,CAA4D,QAFS;wBAMrF,KAAK,OAAA,CAAQ,WAAR,IAAuB,kBANyD;wBASrF,sBAAsB,KAT+D;wBAYrF,YAAY;;oBAEd,MAAA,GAAS,GAAA,CAAI;oBAGP,oBAAoB,MAAA,CAAO,QAAP,CAAgB,cAAhB,CAA+B;oBACzD,IAAI,mBAAmB;wBACrB,YAAA,GAAe,iBAAA,CAAkB;wBACjC,iBAAA,GAAoB,iBAAA,CAAkB;wBACtC,iBAAA,CAAkB,MAAlB;;oBAIFD,IAAI,UAAU;oBACd,MAAA,CAAO,qBAAP,gBAA+B,SAAM,EAAE;oBACvC,MAAA,CAAO,oBAAP,gBAA8B;oBAG9B,MAAA,CAAO,cAAP,GAAwB;wBACtB,0BAAU,EADY;wBAEtB,oBAAO,EAFe;wBAGtB,4BAAW,EAHW;wBAItB,yBAAa,SAAM,IAAI,aAAJ;;oBAIrB,MAAA,CAAO,WAAP,GAAqB,YAAY;yBAC9B,IAAA,CAAK,KAAL,GAAa,IAAI,MAAA,CAAO,WAAX,IAA0B,WAAxC,gBAAsD;yBACrD,IAAA,CAAK,KAAL,GAAa,IAAI,MAAA,CAAO,WAAX,IAA0B,WAAxC,gBAAsD;;oBAIxD,MAAA,CAAO,UAAP,gBAAoB,UAAO;wBAAE,oCAAe;;oBAG5C,IAAI,CAAC,MAAA,CAAO;0BAAW,MAAA,CAAO,SAAP,GAAmB;oBAC1C,MAAA,CAAO,SAAP,CAAiB,aAAjB,GAAiC;wBAC/B,sBAAU,SAAM,IAAI,aAAJ;;oBAIlB,MAAA,CAAO,SAAP,GAAmB;oBAGnB,MAAA,CAAO,OAAP,cAAiB;wBACfD,IAAM,QAAQ,WAAA,CAAY,MAAZ,CAAmB,QAAA,CAAS,OAAT,CAAiB,WAAW;wBAC7D,IAAI,CAAC,OAAO;4BACV,MAAM,KAAA,qDAAsD;;wBAE9DA,IAAM,MAAM;4BAAE,SAAS;;wBACvB,MAAA,CAAO,IAAP,8CAAqD,KAAA,CAAM,MAAN,cAArD,CAA2E,GAAA,CAAI,SAAS,KAAK,MAAA,CAAO;wBACpG,OAAO,GAAA,CAAI;;oBAIb,MAAA,GAAS,MAAA,CAAO,IAAP,CAAY,MAAA,GAAS;;gBAIhC,IAAI,MAAA,IAAU,OAAO,MAAP,KAAkB,UAAU;oBACxC,MAAA,GAAS,mBAAA,CAAoB;;gBAG/B,IAAI,OAAO,MAAP,KAAkB,YAAY;oBAChC,MAAA,GAAS,MAAA,CAAO,OAAA,CAAQ,MAAR,IAAkB;;gBAIpC,IAAI,MAAA,IAAU,MAAA,CAAO,MAAM;oBAChB,OAAM,OAAN;;4BAAT,MAAA,GAAS;;;;;;;;oBAKX,IAAI,MAAA,KAAW,SAAX,IAAwB,OAAA,CAAQ,iBAAiB;wBAC7C,WAAW,MAAA,CAAO,QAAP,CAAgB,aAAhB,CAA8B;wBAC/C,QAAA,CAAS,SAAT,GAAqB,MAAA,IAAU;wBACzB,UAAU,QAAA,CAAS,OAAT,IAAoB;wBAC9B,SAAS,YAAA,IAAgB,MAAA,CAAO,QAAP,CAAgB;wBAC/CC,IAAI;wBACJ,OAAQ,KAAA,GAAQ,OAAA,CAAQ,YAAa;4BACnC,MAAA,CAAO,YAAP,CAAoB,OAAO,iBAAA,IAAqB;;2BAE7C,IAAI,QAAQ;wBAEjB,eAAO,OAAA,CAAQ,eAAR,CAAwB,OAAxB,CAAgC,eAAe,MAAA,IAAU;;oBAK9D,aAAa,GAAA,CAAI,SAAJ;oBACjB,IAAI,CAAC,eAAA,CAAgB,IAAhB,CAAqB,aAAa;wBACrC,UAAA,GAAa,oBAAkB;;oBAEjC,eAAO;;;;;;;;;;;;;"}